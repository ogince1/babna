const { createClient } = require('@supabase/supabase-js');

// Configuration Supabase Cloud
const supabaseUrl = 'https://ubanmapcosqapprxkjld.supabase.co';
const supabaseServiceKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InViYW5tYXBjb3NxYXBwcnhramxkIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NjU0NzI1MSwiZXhwIjoyMDcyMTIzMjUxfQ.nv4uJQfZIIc60vaH2ERCmh449kSVJwyM-ryI5VtE6Jc';

const supabase = createClient(supabaseUrl, supabaseServiceKey);

async function syncProperties() {
  console.log('üè† Synchronisation des appartements avec Supabase Cloud...');

  try {
    // 1. R√©cup√©rer l'ID du propri√©taire
    console.log('üë§ R√©cup√©ration du propri√©taire...');
    
    const { data: authUsers, error: authError } = await supabase.auth.admin.listUsers();
    if (authError) {
      console.log('‚ùå Erreur r√©cup√©ration utilisateurs:', authError.message);
      return;
    }

    const ownerUser = authUsers.users.find(u => u.email === 'proprietaire@babna.ma');
    if (!ownerUser) {
      console.log('‚ùå Utilisateur propri√©taire non trouv√©');
      return;
    }

    console.log(`‚úÖ Propri√©taire trouv√©: ${ownerUser.id}`);

    // 2. Supprimer les propri√©t√©s existantes
    console.log('üóëÔ∏è Suppression des propri√©t√©s existantes...');
    
    const { error: deleteError } = await supabase
      .from('properties')
      .delete()
      .neq('id', '00000000-0000-0000-0000-000000000000'); // Supprimer toutes les propri√©t√©s

    if (deleteError) {
      console.log('‚ö†Ô∏è Erreur suppression propri√©t√©s:', deleteError.message);
    } else {
      console.log('‚úÖ Propri√©t√©s existantes supprim√©es');
    }

    // 3. Ins√©rer toutes les propri√©t√©s
    console.log('üè† Insertion des nouvelles propri√©t√©s...');
    
    const properties = [
      // Marrakech
      {
        title: 'Riad traditionnel au c≈ìur de la M√©dina',
        description: 'Authentique riad marocain avec patio, terrasse et vue sur les toits de Marrakech. Id√©al pour une exp√©rience culturelle authentique.',
        price_per_night: 180.00,
        city: 'Marrakech',
        address: 'Rue Riad Zitoun, M√©dina, Marrakech',
        lat: 31.6295,
        lng: -7.9811,
        bedrooms: 3,
        bathrooms: 2,
        max_guests: 6,
        property_type: 'riad',
        amenities: ['wifi', 'climatisation', 'piscine', 'terrasse', 'cuisine', 'parking'],
        images: [
          'https://images.unsplash.com/photo-1553603229-0f1a5d2c735b?w=800',
          'https://images.unsplash.com/photo-1571896349842-33c89424de2d?w=800'
        ],
        owner_id: ownerUser.id,
        is_available: true
      },
      {
        title: 'Appartement moderne pr√®s de la Koutoubia',
        description: 'Appartement contemporain avec vue sur la mosqu√©e Koutoubia. Proche des souks et des restaurants.',
        price_per_night: 120.00,
        city: 'Marrakech',
        address: 'Avenue Mohammed V, Marrakech',
        lat: 31.6245,
        lng: -7.9836,
        bedrooms: 2,
        bathrooms: 1,
        max_guests: 4,
        property_type: 'appartement',
        amenities: ['wifi', 'climatisation', 'cuisine', 'balcon'],
        images: [
          'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=800',
          'https://images.unsplash.com/photo-1560448075-bb485b067938?w=800'
        ],
        owner_id: ownerUser.id,
        is_available: true
      },
      {
        title: 'Villa avec piscine √† Palmeraie',
        description: 'Magnifique villa avec piscine priv√©e dans la Palmeraie de Marrakech. Calme et luxe garantis.',
        price_per_night: 350.00,
        city: 'Marrakech',
        address: 'Route de la Palmeraie, Marrakech',
        lat: 31.6500,
        lng: -7.9500,
        bedrooms: 4,
        bathrooms: 3,
        max_guests: 8,
        property_type: 'villa',
        amenities: ['wifi', 'climatisation', 'piscine', 'jardin', 'cuisine', 'parking', 'terrasse'],
        images: [
          'https://images.unsplash.com/photo-1571896349842-33c89424de2d?w=800',
          'https://images.unsplash.com/photo-1553603229-0f1a5d2c735b?w=800'
        ],
        owner_id: ownerUser.id,
        is_available: true
      },

      // Casablanca
      {
        title: 'Appartement de luxe √† la Corniche',
        description: 'Appartement moderne avec vue sur l\'oc√©an Atlantique. Proche des plages et du centre-ville.',
        price_per_night: 200.00,
        city: 'Casablanca',
        address: 'Boulevard de la Corniche, Casablanca',
        lat: 33.5731,
        lng: -7.5898,
        bedrooms: 3,
        bathrooms: 2,
        max_guests: 6,
        property_type: 'appartement',
        amenities: ['wifi', 'climatisation', 'balcon', 'cuisine', 'parking'],
        images: [
          'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=800',
          'https://images.unsplash.com/photo-1560448075-bb485b067938?w=800'
        ],
        owner_id: ownerUser.id,
        is_available: true
      },
      {
        title: 'Studio moderne au centre-ville',
        description: 'Studio parfait pour un s√©jour professionnel ou romantique. Proche de la mosqu√©e Hassan II.',
        price_per_night: 90.00,
        city: 'Casablanca',
        address: 'Quartier Habous, Casablanca',
        lat: 33.5950,
        lng: -7.6320,
        bedrooms: 1,
        bathrooms: 1,
        max_guests: 2,
        property_type: 'studio',
        amenities: ['wifi', 'climatisation', 'cuisine'],
        images: [
          'https://images.unsplash.com/photo-1553603229-0f1a5d2c735b?w=800',
          'https://images.unsplash.com/photo-1571896349842-33c89424de2d?w=800'
        ],
        owner_id: ownerUser.id,
        is_available: true
      },

      // Rabat
      {
        title: 'Appartement historique dans la Kasbah',
        description: 'Appartement r√©nov√© dans la Kasbah historique de Rabat. Vue imprenable sur l\'oc√©an.',
        price_per_night: 150.00,
        city: 'Rabat',
        address: 'Kasbah des Oudayas, Rabat',
        lat: 34.0209,
        lng: -6.8416,
        bedrooms: 2,
        bathrooms: 1,
        max_guests: 4,
        property_type: 'appartement',
        amenities: ['wifi', 'climatisation', 'cuisine', 'terrasse'],
        images: [
          'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=800',
          'https://images.unsplash.com/photo-1560448075-bb485b067938?w=800'
        ],
        owner_id: ownerUser.id,
        is_available: true
      },
      {
        title: 'Maison traditionnelle √† Sal√©',
        description: 'Maison traditionnelle marocaine dans la ville jumelle de Rabat. Authenticit√© et charme.',
        price_per_night: 130.00,
        city: 'Rabat',
        address: 'M√©dina de Sal√©, Rabat',
        lat: 34.0333,
        lng: -6.8167,
        bedrooms: 3,
        bathrooms: 2,
        max_guests: 6,
        property_type: 'maison',
        amenities: ['wifi', 'climatisation', 'cuisine', 'jardin'],
        images: [
          'https://images.unsplash.com/photo-1553603229-0f1a5d2c735b?w=800',
          'https://images.unsplash.com/photo-1571896349842-33c89424de2d?w=800'
        ],
        owner_id: ownerUser.id,
        is_available: true
      },

      // F√®s
      {
        title: 'Riad authentique dans la M√©dina de F√®s',
        description: 'Riad traditionnel au c≈ìur de la plus grande m√©dina pi√©tonne du monde. Exp√©rience culturelle unique.',
        price_per_night: 160.00,
        city: 'F√®s',
        address: 'M√©dina de F√®s el-Bali, F√®s',
        lat: 34.0181,
        lng: -5.0078,
        bedrooms: 4,
        bathrooms: 3,
        max_guests: 8,
        property_type: 'riad',
        amenities: ['wifi', 'climatisation', 'piscine', 'terrasse', 'cuisine'],
        images: [
          'https://images.unsplash.com/photo-1571896349842-33c89424de2d?w=800',
          'https://images.unsplash.com/photo-1553603229-0f1a5d2c735b?w=800'
        ],
        owner_id: ownerUser.id,
        is_available: true
      },
      {
        title: 'Appartement moderne √† F√®s Jdid',
        description: 'Appartement contemporain dans le quartier moderne de F√®s. Confort et accessibilit√©.',
        price_per_night: 100.00,
        city: 'F√®s',
        address: 'F√®s Jdid, F√®s',
        lat: 34.0500,
        lng: -5.0000,
        bedrooms: 2,
        bathrooms: 1,
        max_guests: 4,
        property_type: 'appartement',
        amenities: ['wifi', 'climatisation', 'cuisine', 'balcon'],
        images: [
          'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=800',
          'https://images.unsplash.com/photo-1560448075-bb485b067938?w=800'
        ],
        owner_id: ownerUser.id,
        is_available: true
      },

      // Agadir
      {
        title: 'Villa avec vue sur l\'oc√©an',
        description: 'Villa moderne avec vue panoramique sur l\'oc√©an Atlantique. Plage priv√©e et piscine.',
        price_per_night: 280.00,
        city: 'Agadir',
        address: 'Corniche d\'Agadir',
        lat: 30.4278,
        lng: -9.5981,
        bedrooms: 3,
        bathrooms: 2,
        max_guests: 6,
        property_type: 'villa',
        amenities: ['wifi', 'climatisation', 'piscine', 'plage', 'cuisine', 'parking'],
        images: [
          'https://images.unsplash.com/photo-1571896349842-33c89424de2d?w=800',
          'https://images.unsplash.com/photo-1553603229-0f1a5d2c735b?w=800'
        ],
        owner_id: ownerUser.id,
        is_available: true
      },
      {
        title: 'Studio au centre-ville d\'Agadir',
        description: 'Studio moderne au c≈ìur d\'Agadir. Proche des commerces et de la plage.',
        price_per_night: 80.00,
        city: 'Agadir',
        address: 'Centre-ville, Agadir',
        lat: 30.4167,
        lng: -9.5833,
        bedrooms: 1,
        bathrooms: 1,
        max_guests: 2,
        property_type: 'studio',
        amenities: ['wifi', 'climatisation', 'cuisine'],
        images: [
          'https://images.unsplash.com/photo-1553603229-0f1a5d2c735b?w=800',
          'https://images.unsplash.com/photo-1571896349842-33c89424de2d?w=800'
        ],
        owner_id: ownerUser.id,
        is_available: true
      },

      // Tanger
      {
        title: 'Appartement avec vue sur le d√©troit',
        description: 'Appartement avec vue imprenable sur le d√©troit de Gibraltar. Proche de la M√©dina.',
        price_per_night: 140.00,
        city: 'Tanger',
        address: 'Kasbah, Tanger',
        lat: 35.7767,
        lng: -5.8039,
        bedrooms: 2,
        bathrooms: 1,
        max_guests: 4,
        property_type: 'appartement',
        amenities: ['wifi', 'climatisation', 'cuisine', 'terrasse'],
        images: [
          'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=800',
          'https://images.unsplash.com/photo-1560448075-bb485b067938?w=800'
        ],
        owner_id: ownerUser.id,
        is_available: true
      },

      // Essaouira
      {
        title: 'Riad dans la M√©dina d\'Essaouira',
        description: 'Riad traditionnel dans la charmante m√©dina d\'Essaouira. Proche de la plage et du port.',
        price_per_night: 170.00,
        city: 'Essaouira',
        address: 'M√©dina, Essaouira',
        lat: 31.5085,
        lng: -9.7595,
        bedrooms: 3,
        bathrooms: 2,
        max_guests: 6,
        property_type: 'riad',
        amenities: ['wifi', 'climatisation', 'terrasse', 'cuisine'],
        images: [
          'https://images.unsplash.com/photo-1571896349842-33c89424de2d?w=800',
          'https://images.unsplash.com/photo-1553603229-0f1a5d2c735b?w=800'
        ],
        owner_id: ownerUser.id,
        is_available: true
      },

      // Chefchaouen
      {
        title: 'Maison bleue dans la M√©dina',
        description: 'Maison traditionnelle dans la c√©l√®bre ville bleue. Vue sur les montagnes du Rif.',
        price_per_night: 110.00,
        city: 'Chefchaouen',
        address: 'M√©dina, Chefchaouen',
        lat: 35.1714,
        lng: -5.2696,
        bedrooms: 2,
        bathrooms: 1,
        max_guests: 4,
        property_type: 'maison',
        amenities: ['wifi', 'climatisation', 'cuisine', 'terrasse'],
        images: [
          'https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=800',
          'https://images.unsplash.com/photo-1560448075-bb485b067938?w=800'
        ],
        owner_id: ownerUser.id,
        is_available: true
      },

      // Mekn√®s
      {
        title: 'Appartement pr√®s de la M√©dina imp√©riale',
        description: 'Appartement moderne pr√®s de la M√©dina historique de Mekn√®s. Proche des sites touristiques.',
        price_per_night: 95.00,
        city: 'Mekn√®s',
        address: 'M√©dina, Mekn√®s',
        lat: 33.8935,
        lng: -5.5473,
        bedrooms: 2,
        bathrooms: 1,
        max_guests: 4,
        property_type: 'appartement',
        amenities: ['wifi', 'climatisation', 'cuisine', 'balcon'],
        images: [
          'https://images.unsplash.com/photo-1553603229-0f1a5d2c735b?w=800',
          'https://images.unsplash.com/photo-1571896349842-33c89424de2d?w=800'
        ],
        owner_id: ownerUser.id,
        is_available: true
      }
    ];

    const { data: insertedProperties, error: insertError } = await supabase
      .from('properties')
      .insert(properties)
      .select();

    if (insertError) {
      console.log('‚ùå Erreur insertion propri√©t√©s:', insertError.message);
    } else {
      console.log(`‚úÖ ${insertedProperties.length} propri√©t√©s ins√©r√©es avec succ√®s`);
    }

    // 4. V√©rifier les donn√©es par ville
    console.log('üìä V√©rification des donn√©es par ville...');
    
    const cities = ['Marrakech', 'Casablanca', 'Rabat', 'F√®s', 'Agadir', 'Tanger', 'Essaouira', 'Chefchaouen', 'Mekn√®s'];
    
    for (const city of cities) {
      const { data: cityProperties } = await supabase
        .from('properties')
        .select('count')
        .eq('city', city);
      
      console.log(`- ${city}: ${cityProperties?.length || 0} propri√©t√©s`);
    }

    // 5. Statistiques globales
    const { data: allProperties } = await supabase
      .from('properties')
      .select('*');

    console.log('\nüìà Statistiques globales:');
    console.log(`- Total propri√©t√©s: ${allProperties?.length || 0}`);
    console.log(`- Prix moyen: ${(allProperties?.reduce((sum, p) => sum + p.price_per_night, 0) / (allProperties?.length || 1)).toFixed(2)} MAD/nuit`);
    console.log(`- Types: ${[...new Set(allProperties?.map(p => p.property_type) || [])].join(', ')}`);

    console.log('\nüéâ Synchronisation termin√©e avec succ√®s !');

  } catch (error) {
    console.error('‚ùå Erreur lors de la synchronisation:', error);
  }
}

// Ex√©cuter le script
syncProperties();
